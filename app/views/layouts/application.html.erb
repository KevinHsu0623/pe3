<!DOCTYPE html>
<html>
 <head>
    <title>PE3 工程碳排估算平台</title>
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <%= stylesheet_link_tag "application", media: "all" %>

    <!-- ✅ 只保留這一行 JavaScript 模組引入 -->
    <%= javascript_include_tag "application", type: "module", "data-turbo-track": "reload" %>
  </head>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const input = document.getElementById("material-search-input");
    const results = document.getElementById("search-results");
    const hiddenId = document.getElementById("carbon-emission-id");

    if (!input) return;

    input.addEventListener("input", function () {
      const keyword = input.value.trim();
      const projectId = "<%= @project&.id %>"; // Rails 變數，確保定義

      if (keyword.length < 1) {
        results.innerHTML = "";
        return;
      }

      fetch(`/projects/${projectId}/material_usages/search.json?keyword=${keyword}`)
        .then(response => response.json())
        .then(data => {
          results.innerHTML = data.map(item => `
            <button type="button" class="list-group-item list-group-item-action"
              data-id="${item.id}" data-name="${item.item_name}">
              ${item.item_name} (${item.unit}, ${item.carbon_emission_value})
            </button>
          `).join("");

          document.querySelectorAll("#search-results button").forEach(button => {
            button.addEventListener("click", function () {
              input.value = this.dataset.name;
              hiddenId.value = this.dataset.id;
              results.innerHTML = "";
            });
          });
        });
    });
  });
</script>
  <body class="container py-4">
    <header class="mb-4">
      <nav>
        <ul class="nav nav-pills">
          <% if user_signed_in? %>
            <li class="nav-item"><%= link_to "首頁", root_path, class: "nav-link" %></li>
            <li class="nav-item"><%= link_to "登出", destroy_user_session_path, method: :delete, data: { confirm: "確定要登出嗎？" }, class: "nav-link" %></li>
          <% else %>
            <li class="nav-item"><%= link_to "登入", new_user_session_path, class: "nav-link" %></li>
            <li class="nav-item"><%= link_to "註冊", new_user_registration_path, class: "nav-link" %></li>
          <% end %>
        </ul>
      </nav>
    </header>

    <main>
    
      <%= yield %>
    </main>

    <footer class="text-center text-muted mt-5 mb-3">
      &copy; <%= Time.current.year %> PE3 工程碳排平台
    </footer>
  </body>
</html>
